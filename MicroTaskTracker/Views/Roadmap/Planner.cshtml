@using MicroTaskTracker.Models.ViewModels.Roadmaps;
@model RoadmapPlannerViewModel

@{
    ViewData["Title"] = "Task Assignment";
}

<div class="roadmap-page-bg">
    <div class="container py-5">

        <div class="d-flex justify-content-between align-items-end mb-5 animate-fade-in">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        @* Use Edit (GET) to avoid 405 Method Not Allowed error *@
                        <li class="breadcrumb-item">
                            <a asp-action="Edit" asp-route-id="@Model.RoadmapId" class="text-decoration-none">Back to Roadmap</a>
                        </li>
                        <li class="breadcrumb-item active">Assign Tasks</li>
                    </ol>
                </nav>
                <h1 class="fw-bold mb-0">Strategy Planner</h1>
                <p class="text-muted mb-0">Select tasks to link them to this milestone.</p>
            </div>

            <a asp-action="Edit" asp-route-id="@Model.RoadmapId" class="btn btn-primary btn-lg rounded-pill px-5 shadow-lg">
                <i class="bi bi-check-circle-fill me-2"></i>Done
            </a>
        </div>

        @if (Model.UnlinkedTasks == null || !Model.UnlinkedTasks.Any())
        {
            <div class="text-center py-5 border rounded-4 bg-white shadow-sm">
                <i class="bi bi-clipboard-x display-1 text-muted"></i>
                <h3 class="mt-3">No unlinked tasks found</h3>
                <p class="text-muted">Create some standalone tasks first or check other milestones.</p>
                <a asp-controller="Tasks" asp-action="Index" class="btn btn-outline-primary mt-2">Go to Task Manager</a>
            </div>
        }
        else
        {
            <div class="row g-4">
                @foreach (var task in Model.UnlinkedTasks)
                {
                    <div class="col-md-6 col-lg-4" id="task-wrapper-@task.Id">
                        <div class="card h-100 planner-selection-card"
                             id="planner-card-@task.Id"
                             onclick="RoadmapPlanner.toggleTask(@task.Id, @Model.TargetActionId)">

                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between">
                                    <h5 class="card-title fw-bold">@task.Title</h5>

                                    @* FIX: "X" button now hides the wrapper div safely *@
                                    <button type="button" class="btn-close shadow-none"
                                            onclick="document.getElementById('task-wrapper-@task.Id').style.display='none'; event.stopPropagation();"
                                            title="Hide from list"></button>
                                </div>

                                <p class="card-text text-muted small mb-3">@task.Description</p>

                                <div class="planner-footer d-flex align-items-center mt-3">
                                    <span class="badge bg-light text-dark border">
                                        <i class="bi bi-calendar-event me-1"></i>
                                        @(task.DueDate.HasValue? task.DueDate.Value.ToString("MMM dd") : "No Date")
                                    </span>
                                </div>
                            </div>

                            @* VISUAL INDICATOR: Shown when card has .selected class *@
                            <div class="planner-selection-indicator">
                                <i class="bi bi-check-lg"></i>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Inline script to ensure the animation logic is immediate
        var RoadmapPlanner = {
            toggleTask: function(taskId, actionId) {
                const card = document.getElementById(`planner-card-${taskId}`);

                // 1. Trigger Animation / Selection State
                card.classList.toggle('selected');

                // 2. Determine Action
                const isLinking = card.classList.contains('selected');
                const targetUrl = isLinking ? '/Roadmaps/LinkTask' : '/Roadmaps/UnlinkTask';

                // 3. Background Save
                fetch(targetUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ taskId: taskId, actionId: actionId })
                }).then(response => {
                    if (!response.ok) {
                        card.classList.toggle('selected'); // Revert UI on failure
                        console.error("Failed to update link");
                    }
                });
            }
        };
    </script>
}