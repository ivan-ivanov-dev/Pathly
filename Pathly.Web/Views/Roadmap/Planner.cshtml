@using Pathly.ViewModels.Roadmaps
@model RoadmapPlannerViewModel

@{
    ViewData["Title"] = "Strategy Planner";
}

@section Styles {
    <link rel="stylesheet" href="~/css/roadmap.css" asp-append-version="true" />
}

<div class="roadmap-page-bg min-vh-100">
    <div class="container py-5">
        @* FORM START *@
        <form asp-action="SaveAssignments" method="post" id="assignmentForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="actionId" value="@Model.TargetActionId" />
            <input type="hidden" name="roadmapId" value="@Model.RoadmapId" />
            @* This hidden input stores the list of IDs to be saved *@
            <input type="hidden" id="selectedTaskIds" name="selectedTaskIds" value="" />

            <div class="d-flex justify-content-between align-items-center mb-5 animate-fade-in">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item">
                                <a asp-action="Details" asp-route-id="@Model.RoadmapId" class="text-decoration-none">Back to Details</a>
                            </li>
                            <li class="breadcrumb-item active">Assign Tasks</li>
                        </ol>
                    </nav>
                    <h1 class="fw-bold mb-0 text-dark">Strategic Mapping</h1>
                    <p class="text-muted">Select the cards you want to link, then click Save.</p>
                </div>

                <button type="submit" class="btn btn-primary btn-lg rounded-pill px-5 shadow-lg">
                    <i class="bi bi-check-circle-fill me-2"></i>Save & Done
                </button>
            </div>

            @if (Model.UnlinkedTasks == null || !Model.UnlinkedTasks.Any())
            {
                <div class="text-center py-5 border rounded-4 bg-white shadow-sm">
                    <i class="bi bi-clipboard-x display-1 text-muted"></i>
                    <h3 class="mt-3">All clear!</h3>
                    <p class="text-muted">No unlinked tasks available to assign.</p>
                    <a asp-controller="Tasks" asp-action="Index" class="btn btn-outline-primary mt-2">Manage All Tasks</a>
                </div>
            }
            else
            {
                <div class="row g-4">
                    @foreach (var task in Model.UnlinkedTasks)
                    {
                        <div class="col-md-6 col-lg-4">
                            <div class="card h-100 planner-selection-card border-0 shadow-sm"
                                 id="planner-card-@task.Id"
                                 onclick="RoadmapUI.toggleLocalSelection(this, @task.Id)">

                                <div class="card-body p-4">
                                    <h5 class="card-title fw-bold mb-2">@task.Title</h5>
                                    <p class="card-text text-muted small mb-3">@task.Description</p>

                                    <div class="mt-auto pt-3">
                                        <span class="badge bg-light text-dark border">
                                            <i class="bi bi-calendar-event me-1"></i>
                                            @(task.DueDate.HasValue? task.DueDate.Value.ToString("MMM dd") : "No Date")
                                        </span>
                                    </div>
                                </div>

                                <div class="planner-selection-indicator">
                                    <i class="bi bi-check-lg"></i>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Track selections locally in memory until the form is submitted
        let selectedSet = new Set();

        var RoadmapUI = {
            toggleLocalSelection: function(cardElement, taskId) {
                // 1. Toggle Visuals
                cardElement.classList.toggle('selected');

                // 2. Update the Set
                if (cardElement.classList.contains('selected')) {
                    selectedSet.add(taskId);
                } else {
                    selectedSet.delete(taskId);
                }

                // 3. Update the hidden input with a comma-separated list
                document.getElementById('selectedTaskIds').value = Array.from(selectedSet).join(',');
            }
        };
                var RoadmapDetails = {
            unlinkTask: function(taskId) {
                if (!confirm("Are you sure you want to remove this task from this milestone?")) return;

                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const url = '@Url.Action("UnlinkTask", "Roadmaps")' + '?taskId=' + taskId;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // Fade out and remove the element from the list
                        const element = document.getElementById(`task-item-${taskId}`);
                        element.style.transition = "all 0.3s ease";
                        element.style.opacity = "0";
                        element.style.transform = "translateX(20px)";
                        setTimeout(() => element.remove(), 300);
                    } else {
                        alert("Could not unlink task. Please try again.");
                    }
                })
                .catch(err => console.error("Error:", err));
            }
        };
    </script>
}